name: Build Android libvips (MobiPkg)

on:
  workflow_dispatch:

# This workflow builds libvips for Android using MobiPkg/Compile
# 
# The workflow clones the MobiPkg/Compile repository and uses its Dart-based
# workspace build system to compile libvips for all Android architectures.
#
# Build script: https://github.com/MobiPkg/Compile/blob/main/example/libvips/build-android-with-workspace.sh
# Reference workflow: https://github.com/MobiPkg/Compile/blob/main/.github/workflows/build-libvips-android.yml

jobs:
  build-android:
    runs-on: ubuntu-latest
    name: Build libvips Android libraries
    permissions:
      contents: write
    outputs:
      build_date: ${{ steps.build-info.outputs.build_date }}
      build_tag: ${{ steps.build-info.outputs.build_tag }}
      mobipkg_commit: ${{ steps.mobipkg-info.outputs.mobipkg_commit }}
      mobipkg_ref: ${{ steps.mobipkg-info.outputs.mobipkg_ref }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate build information
        id: build-info
        run: |
          BUILD_DATE=$(date -u +"%Y-%m-%d")
          BUILD_TAG="android-mobipkg-${BUILD_DATE}-${{ github.run_number }}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "build_tag=${BUILD_TAG}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          echo "Build Date: ${BUILD_DATE}"
          echo "Build Tag: ${BUILD_TAG}"
          echo "Build Time: ${BUILD_TIME}"

      - name: Checkout MobiPkg/Compile
        uses: actions/checkout@v4
        with:
          repository: MobiPkg/Compile
          path: MobiPkg-Compile

      - name: Get MobiPkg/Compile commit info
        id: mobipkg-info
        run: |
          cd MobiPkg-Compile
          MOBIPKG_COMMIT=$(git rev-parse HEAD)
          MOBIPKG_REF=$(git describe --tags --always)
          echo "mobipkg_commit=${MOBIPKG_COMMIT}" >> $GITHUB_OUTPUT
          echo "mobipkg_ref=${MOBIPKG_REF}" >> $GITHUB_OUTPUT
          echo "MobiPkg/Compile commit: ${MOBIPKG_COMMIT}"
          echo "MobiPkg/Compile ref: ${MOBIPKG_REF}"

      - name: Setup Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            autoconf \
            automake \
            libtool \
            pkg-config \
            gettext \
            libglib2.0-dev \
            python3-pip \
            ninja-build
          pip3 install meson

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: |
          sdkmanager --install "ndk;29.0.14206865"
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/29.0.14206865" >> $GITHUB_ENV

      - name: Get Dart dependencies
        run: dart pub get
        working-directory: MobiPkg-Compile

      - name: Build libvips for Android
        run: |
          chmod +x example/libvips/build-android-with-workspace.sh
          ./example/libvips/build-android-with-workspace.sh --clean
        working-directory: MobiPkg-Compile
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: Verify build output
        id: verify
        run: |
          INSTALL_DIR="MobiPkg-Compile/example/libvips/installed/android"
          
          echo "=== Checking build output ==="
          
          # Check for expected architectures
          ARCHS=("arm64-v8a" "armeabi-v7a" "x86" "x86_64")
          MISSING_ARCHS=""
          
          for arch in "${ARCHS[@]}"; do
            if [ ! -d "$INSTALL_DIR/$arch" ]; then
              echo "❌ Missing architecture: $arch"
              MISSING_ARCHS="$MISSING_ARCHS $arch"
            else
              echo "✅ Found architecture: $arch"
            fi
          done
          
          if [ -n "$MISSING_ARCHS" ]; then
            echo "::error::Missing architectures:$MISSING_ARCHS"
            exit 1
          fi
          
          # Check for libvips.so in each architecture
          for arch in "${ARCHS[@]}"; do
            if [ ! -f "$INSTALL_DIR/$arch/lib/libvips.so" ]; then
              echo "::error::Missing libvips.so for $arch"
              exit 1
            fi
            echo "✅ Found libvips.so for $arch"
          done
          
          # Check for include files
          if [ ! -d "$INSTALL_DIR/arm64-v8a/include/vips" ]; then
            echo "::error::Missing vips include directory"
            exit 1
          fi
          echo "✅ Found vips include directory"
          
          # List all .so files
          echo ""
          echo "=== Library files ==="
          for arch in "${ARCHS[@]}"; do
            echo "--- $arch ---"
            find "$INSTALL_DIR/$arch/lib" -name "*.so" -o -name "*.a" 2>/dev/null | head -20
          done
          
          echo ""
          echo "=== Include files ==="
          ls -la "$INSTALL_DIR/arm64-v8a/include/" | head -20

      - name: Prepare artifacts
        run: |
          INSTALL_DIR="MobiPkg-Compile/example/libvips/installed/android"
          ARTIFACT_DIR="libvips-android-artifacts"
          
          mkdir -p "$ARTIFACT_DIR"
          
          # Copy libraries for each architecture
          for arch in arm64-v8a armeabi-v7a x86 x86_64; do
            mkdir -p "$ARTIFACT_DIR/jniLibs/$arch"
            # Copy all .so files
            find "$INSTALL_DIR/$arch/lib" -name "*.so" -exec cp {} "$ARTIFACT_DIR/jniLibs/$arch/" \;
          done
          
          # Copy include files (use arm64-v8a as reference, they should be the same)
          cp -r "$INSTALL_DIR/arm64-v8a/include" "$ARTIFACT_DIR/"
          
          # Copy glibconfig.h from lib/glib-2.0/include/ (architecture-specific glib header)
          # This file is required for compiling against glib
          if [ -f "$INSTALL_DIR/arm64-v8a/lib/glib-2.0/include/glibconfig.h" ]; then
            mkdir -p "$ARTIFACT_DIR/include/glib-2.0"
            cp "$INSTALL_DIR/arm64-v8a/lib/glib-2.0/include/glibconfig.h" "$ARTIFACT_DIR/include/glib-2.0/"
            echo "✅ Copied glibconfig.h"
          else
            echo "::warning::glibconfig.h not found in expected location"
            # Try to find it
            find "$INSTALL_DIR" -name "glibconfig.h" 2>/dev/null || echo "glibconfig.h not found anywhere"
          fi
          
          # Create a summary file
          echo "libvips Android Build" > "$ARTIFACT_DIR/BUILD_INFO.txt"
          echo "=====================" >> "$ARTIFACT_DIR/BUILD_INFO.txt"
          echo "Build Date: $(date -u)" >> "$ARTIFACT_DIR/BUILD_INFO.txt"
          echo "Commit: ${{ github.sha }}" >> "$ARTIFACT_DIR/BUILD_INFO.txt"
          echo "" >> "$ARTIFACT_DIR/BUILD_INFO.txt"
          echo "Architectures:" >> "$ARTIFACT_DIR/BUILD_INFO.txt"
          for arch in arm64-v8a armeabi-v7a x86 x86_64; do
            echo "  - $arch" >> "$ARTIFACT_DIR/BUILD_INFO.txt"
          done
          echo "" >> "$ARTIFACT_DIR/BUILD_INFO.txt"
          echo "Libraries included:" >> "$ARTIFACT_DIR/BUILD_INFO.txt"
          ls "$ARTIFACT_DIR/jniLibs/arm64-v8a/" >> "$ARTIFACT_DIR/BUILD_INFO.txt"
          
          echo "=== Artifact structure ==="
          find "$ARTIFACT_DIR" -type f | head -50

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libvips-android-${{ steps.build-info.outputs.build_tag }}
          path: libvips-android-artifacts/
          retention-days: 30

      - name: Verify uploaded artifacts
        run: |
          echo "=== Final verification ==="
          ARTIFACT_DIR="libvips-android-artifacts"
          
          # Count .so files per architecture
          for arch in arm64-v8a armeabi-v7a x86 x86_64; do
            COUNT=$(find "$ARTIFACT_DIR/jniLibs/$arch" -name "*.so" | wc -l)
            echo "$arch: $COUNT .so files"
            if [ "$COUNT" -lt 5 ]; then
              echo "::warning::Low number of libraries for $arch (expected at least 5)"
            fi
          done
          
          # Verify key libraries exist
          KEY_LIBS=("libvips.so" "libglib-2.0.so" "libgobject-2.0.so")
          for lib in "${KEY_LIBS[@]}"; do
            if [ ! -f "$ARTIFACT_DIR/jniLibs/arm64-v8a/$lib" ]; then
              echo "::warning::Key library missing: $lib"
            else
              echo "✅ Found key library: $lib"
            fi
          done
          
          # Verify include files
          if [ -f "$ARTIFACT_DIR/include/vips/vips.h" ]; then
            echo "✅ Found vips.h header"
          else
            echo "::warning::vips.h header not found"
          fi
          
          # Verify glibconfig.h
          if [ -f "$ARTIFACT_DIR/include/glib-2.0/glibconfig.h" ]; then
            echo "✅ Found glibconfig.h header"
          else
            echo "::error::glibconfig.h header not found - required for glib compilation"
            exit 1
          fi

      - name: Package build artifacts for release
        id: package
        run: |
          BUILD_TAG="${{ steps.build-info.outputs.build_tag }}"
          ARTIFACT_DIR="libvips-android-artifacts"
          
          echo "============================================"
          echo "Creating Package Archive"
          echo "============================================"
          
          # Create compressed archive
          cd "$ARTIFACT_DIR"
          ARCHIVE_NAME="libvips-android-mobipkg-${BUILD_TAG}.tar.xz"
          tar -cJf "/tmp/${ARCHIVE_NAME}" jniLibs include BUILD_INFO.txt
          
          echo "archive_path=/tmp/${ARCHIVE_NAME}" >> $GITHUB_OUTPUT
          echo "archive_name=${ARCHIVE_NAME}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Archive created: ${ARCHIVE_NAME}"
          ls -lh "/tmp/${ARCHIVE_NAME}"
          
          echo ""
          echo "Archive contents (first 50 entries):"
          tar -tf "/tmp/${ARCHIVE_NAME}" | head -50
          
          echo ""
          TOTAL_ENTRIES=$(tar -tf "/tmp/${ARCHIVE_NAME}" | wc -l)
          echo "Total entries in archive: $TOTAL_ENTRIES"

      - name: Generate release notes
        id: release-notes
        run: |
          BUILD_TAG="${{ steps.build-info.outputs.build_tag }}"
          BUILD_TIME="${{ steps.build-info.outputs.build_time }}"
          NDK_VERSION="29.0.14206865"
          MOBIPKG_COMMIT="${{ steps.mobipkg-info.outputs.mobipkg_commit }}"
          MOBIPKG_REF="${{ steps.mobipkg-info.outputs.mobipkg_ref }}"
          
          cat << RELEASE_EOF > /tmp/release-notes.md
          # Android libvips Build (MobiPkg) - ${BUILD_TAG}
          
          ## Build Information
          
          | Item | Value |
          |------|-------|
          | **Build Date** | ${{ steps.build-info.outputs.build_date }} |
          | **Build Time (UTC)** | ${BUILD_TIME} |
          | **Build Tag** | ${BUILD_TAG} |
          | **Build Method** | MobiPkg/Compile |
          | **GitHub Run ID** | ${{ github.run_id }} |
          | **GitHub Run Number** | ${{ github.run_number }} |
          
          ## Source References
          
          ### This Repository
          - **Repository**: [${{ github.repository }}](https://github.com/${{ github.repository }})
          - **Commit**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **Workflow File**: [build-android-libvips-mobipkg.yml](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/.github/workflows/build-android-libvips-mobipkg.yml)
          - **Workflow Run**: [Run #${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ### MobiPkg/Compile
          - **Repository**: [MobiPkg/Compile](https://github.com/MobiPkg/Compile)
          - **Commit**: [${MOBIPKG_COMMIT}](https://github.com/MobiPkg/Compile/commit/${MOBIPKG_COMMIT})
          - **Ref**: ${MOBIPKG_REF}
          - **Build Script**: [build-android-with-workspace.sh](https://github.com/MobiPkg/Compile/blob/main/example/libvips/build-android-with-workspace.sh)
          - **Reference Workflow**: [build-libvips-android.yml](https://github.com/MobiPkg/Compile/blob/main/.github/workflows/build-libvips-android.yml)
          
          ## GitHub Actions Used
          
          | Action | Version |
          |--------|---------|
          | actions/checkout | v4 |
          | dart-lang/setup-dart | v1 |
          | android-actions/setup-android | v3 |
          | actions/upload-artifact | v4 |
          | softprops/action-gh-release | v2 |
          
          ## Build Environment
          
          ### System
          - **Runner**: \`ubuntu-latest\`
          - **Architecture**: x86_64
          
          ### Linux Distribution
          RELEASE_EOF
          
          echo '```' >> /tmp/release-notes.md
          cat /etc/os-release >> /tmp/release-notes.md
          echo '```' >> /tmp/release-notes.md
          
          cat << RELEASE_EOF2 >> /tmp/release-notes.md
          
          ### Android NDK
          - **Version**: ${NDK_VERSION}
          - **Path**: \`\${ANDROID_HOME}/ndk/${NDK_VERSION}\`
          
          ### Build Tools
          
          | Tool | Version | Install Command |
          |------|---------|-----------------|
          RELEASE_EOF2
          
          echo "| meson | $(meson --version) | \`pip3 install meson\` |" >> /tmp/release-notes.md
          echo "| ninja | $(ninja --version) | \`sudo apt-get install ninja-build\` |" >> /tmp/release-notes.md
          echo "| automake | $(automake --version | head -1 | awk '{print $NF}') | \`sudo apt-get install automake\` |" >> /tmp/release-notes.md
          echo "| autoconf | $(autoconf --version | head -1 | awk '{print $NF}') | \`sudo apt-get install autoconf\` |" >> /tmp/release-notes.md
          echo "| libtool | $(libtool --version | head -1 | awk '{print $NF}') | \`sudo apt-get install libtool\` |" >> /tmp/release-notes.md
          echo "| pkg-config | $(pkg-config --version) | \`sudo apt-get install pkg-config\` |" >> /tmp/release-notes.md
          echo "| Dart SDK | $(dart --version 2>&1 | awk '{print $4}') | \`dart-lang/setup-dart@v1\` |" >> /tmp/release-notes.md
          echo "| Python | $(python3 --version | awk '{print $2}') | System |" >> /tmp/release-notes.md
          
          cat << 'RELEASE_EOF3' >> /tmp/release-notes.md
          
          ## Dependencies Installation
          
          To reproduce this build environment on Ubuntu/Debian Linux:
          
          ```bash
          # Update package list
          sudo apt-get update
          
          # Install system dependencies
          sudo apt-get install -y \
            autoconf \
            automake \
            libtool \
            pkg-config \
            gettext \
            libglib2.0-dev \
            python3-pip \
            ninja-build \
            xz-utils
          
          # Install meson via pip
          pip3 install meson
          
          # Install Dart SDK
          sudo apt-get install -y apt-transport-https
          wget -qO- https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/dart.gpg
          echo 'deb [signed-by=/usr/share/keyrings/dart.gpg arch=amd64] https://storage.googleapis.com/download.dartlang.org/linux/debian stable main' | sudo tee /etc/apt/sources.list.d/dart_stable.list
          sudo apt-get update
          sudo apt-get install -y dart
          
          # Install Android NDK via sdkmanager or download from:
          # https://developer.android.com/ndk/downloads
          export ANDROID_NDK_HOME=/path/to/your/ndk
          ```
          
          ## Supported Architectures
          
          | Architecture | Android ABI | Description | Status |
          |-------------|-------------|-------------|--------|
          | arm64 | arm64-v8a | 64-bit ARM devices | ✓ Built |
          | armv7a | armeabi-v7a | 32-bit ARM devices | ✓ Built |
          | x86 | x86 | 32-bit x86 emulator | ✓ Built |
          | x86_64 | x86_64 | 64-bit x86 emulator | ✓ Built |
          
          ## Included Libraries
          
          The following libraries are compiled and bundled:
          
          | Library | Description |
          |---------|-------------|
          | zlib | Compression library |
          | libffi | Foreign function interface library |
          | pcre2 | Perl Compatible Regular Expressions |
          | expat | XML parser library |
          | glib | Core application building blocks |
          | libjpeg-turbo | JPEG image codec |
          | libpng | PNG image codec |
          | libwebp | WebP image codec |
          | libvips | Image processing library |
          
          ## How to Use
          
          1. Download `libvips-android-mobipkg-*.tar.xz` from this release
          2. Extract: `tar -xvf libvips-android-mobipkg-*.tar.xz`
          3. Copy `jniLibs` folder to your Android project's `app/src/main/` directory
          4. Copy `include` folder if you need C/C++ headers
          
          ## Comparison with Conan Build
          
          This build uses MobiPkg/Compile as an alternative to the Conan-based build.
          The main differences are:
          
          | Aspect | MobiPkg Build | Conan Build |
          |--------|--------------|-------------|
          | Build System | Dart-based workspace | Python-based Conan |
          | Dependency Management | workspace.yaml | conanfile.py |
          | Configuration | lib.yaml files | Conan profiles |
          | Library Type | Static (.a) + Shared (.so) if available | Shared (.so) primarily |
          
          RELEASE_EOF3
          
          echo "Release notes generated"
          cat /tmp/release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.build-info.outputs.build_tag }}
          name: Android libvips (MobiPkg) - ${{ steps.build-info.outputs.build_tag }}
          body_path: /tmp/release-notes.md
          draft: false
          prerelease: false
          files: ${{ steps.package.outputs.archive_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
